name: integration-tests
on:
  issue_comment:
    types: [created]

permissions:
  id-token: write
  contents: read
  pull-requests: read
  issues: read
  checks: write

jobs:
  integration-test:
    # Only run if:
    # 1. Comment is on a PR (not an issue)
    # 2. Comment contains the trigger phrase
    # 3. Commenter is owner or member
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-integration-tests') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        uses: actions/github-script@v8
        id: get-pr
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            // Validate branch names contain only safe characters
            const branchRegex = /^[a-zA-Z0-9._\/-]+$/;
            if (!branchRegex.test(pr.data.head.ref) || !branchRegex.test(pr.data.base.ref)) {
              throw new Error('Invalid branch name detected');
            }
            console.log(`PR #${context.issue.number}: head_ref=${pr.data.head.ref}, head_sha=${pr.data.head.sha}`);
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('head_sha', pr.data.head.sha);

      - name: Create check run
        uses: actions/github-script@v8
        id: create-check
        env:
          HEAD_SHA: ${{ steps.get-pr.outputs.head_sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const headSha = process.env.HEAD_SHA;
            if (!headSha) {
              throw new Error('HEAD_SHA is empty or not set');
            }
            console.log(`Creating check run for SHA: ${headSha}`);
            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Integration Tests',
              head_sha: headSha,
              status: 'in_progress',
              started_at: new Date().toISOString(),
              details_url: process.env.RUN_URL,
              output: {
                title: 'Integration Tests',
                summary: `Running integration tests...\n\n[View workflow run](${process.env.RUN_URL})`
              }
            });
            console.log(`Created check run with ID: ${check.data.id}`);
            core.setOutput('check_run_id', check.data.id);

      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.get-pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Get changed files and determine tests to run
        id: changed-files
        env:
          BASE_REF: ${{ steps.get-pr.outputs.base_ref }}
        run: |
          # Fetch base branch for comparison
          git fetch origin "$BASE_REF"

          # Get all changed files
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF"...HEAD)

          TEST_DIRS=""

          # 1. Check for changed mapping files -> run corresponding test
          CHANGED_MAPPINGS=$(echo "$CHANGED_FILES" | grep -E '^mappings/.*\.yml$' | \
            grep -v 'yamllint-config.yml' || true)

          for file in $CHANGED_MAPPINGS; do
            # Extract type and name from mappings/<type>/<name>.yml
            if [[ "$file" =~ ^mappings/([^/]+)/([^/]+)\.yml$ ]]; then
              TYPE="${BASH_REMATCH[1]}"
              NAME="${BASH_REMATCH[2]}"
              TEST_DIR="integration-tests/${TYPE}/${NAME}"

              if [ -d "$TEST_DIR" ]; then
                TEST_DIRS="$TEST_DIRS $TEST_DIR"
              fi
            fi
          done

          # 2. Check for changed integration test files -> run that test
          CHANGED_TESTS=$(echo "$CHANGED_FILES" | grep -E '^integration-tests/' || true)

          for file in $CHANGED_TESTS; do
            # Extract type and name from integration-tests/<type>/<name>/...
            # Skip files directly in integration-tests/ or integration-tests/modules/
            if [[ "$file" =~ ^integration-tests/([^/]+)/([^/]+)/ ]]; then
              TYPE="${BASH_REMATCH[1]}"
              NAME="${BASH_REMATCH[2]}"

              # Skip the shared modules directory
              if [ "$TYPE" = "modules" ]; then
                continue
              fi

              TEST_DIR="integration-tests/${TYPE}/${NAME}"
              if [ -d "$TEST_DIR" ]; then
                TEST_DIRS="$TEST_DIRS $TEST_DIR"
              fi
            fi
          done

          # Trim and deduplicate
          TEST_DIRS=$(echo "$TEST_DIRS" | xargs -n1 | sort -u | xargs)
          echo "test_dirs=$TEST_DIRS" >> "$GITHUB_OUTPUT"
          echo "Found test directories: $TEST_DIRS"

      - name: Configure AWS credentials
        if: steps.changed-files.outputs.test_dirs != ''
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_OIDC_ROLE_NAME }}
          role-session-name: integration-test-run-${{ github.run_id }}

      - name: Verify AWS credentials
        if: steps.changed-files.outputs.test_dirs != ''
        run: aws sts get-caller-identity

      - name: Setup Terraform
        if: steps.changed-files.outputs.test_dirs != ''
        uses: hashicorp/setup-terraform@v3

      - name: Run integration tests
        if: steps.changed-files.outputs.test_dirs != ''
        env:
          TEST_DIRS: ${{ steps.changed-files.outputs.test_dirs }}
        run: |
          for dir in $TEST_DIRS; do
            echo "::group::Running tests in $dir"
            cd "$dir"
            terraform init -no-color
            terraform test -no-color
            cd - > /dev/null
            echo "::endgroup::"
          done

      - name: No tests to run
        if: steps.changed-files.outputs.test_dirs == ''
        run: |
          echo "No relevant changes found (no mappings or integration test files changed)."

      - name: Update check run
        if: always() && steps.create-check.outputs.check_run_id
        uses: actions/github-script@v8
        env:
          CHECK_RUN_ID: ${{ steps.create-check.outputs.check_run_id }}
          JOB_STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const conclusion = process.env.JOB_STATUS === 'success' ? 'success' : 'failure';
            const baseMessage = conclusion === 'success'
              ? 'All integration tests passed!'
              : 'Integration tests failed.';
            const summary = `${baseMessage}\n\n[View workflow run](${process.env.RUN_URL})`;
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: parseInt(process.env.CHECK_RUN_ID),
              status: 'completed',
              conclusion: conclusion,
              completed_at: new Date().toISOString(),
              output: {
                title: 'Integration Tests',
                summary: summary
              }
            });
