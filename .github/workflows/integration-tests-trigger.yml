name: integration-tests-trigger
on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  pull-requests: read

jobs:
  trigger-integration-tests:
    # Only run if:
    # 1. Comment is on a PR (not an issue)
    # 2. Comment contains the trigger phrase
    # 3. Commenter is owner or member
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-integration-tests') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details and re-run integration tests workflow
        uses: actions/github-script@v8
        with:
          script: |
            // Get PR details to find the head SHA
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const headSha = pr.data.head.sha;
            console.log(`PR #${context.issue.number} head SHA: ${headSha}`);

            // Find the most recent integration-tests workflow run for this PR's head SHA
            const workflowRuns = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'integration-tests.yml',
              head_sha: headSha,
              per_page: 1
            });

            if (workflowRuns.data.workflow_runs.length === 0) {
              console.log('No workflow run found for this SHA. The PR may need a new commit or the workflow has not run yet.');
              return;
            }

            const workflowRun = workflowRuns.data.workflow_runs[0];
            console.log(`Found workflow run ${workflowRun.id} with status: ${workflowRun.status}`);

            // Re-run the workflow
            await github.rest.actions.reRunWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: workflowRun.id
            });

            console.log(`Re-run triggered for workflow run ${workflowRun.id}`);
